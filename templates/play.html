{% extends "base.html" %}

{% block title %}AC - Play{% endblock %}
{% block head_includes %}
<script src="https://unpkg.com/wavesurfer.js@7"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/regions.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/hover.min.js"></script>
<script src="https://unpkg.com/wavesurfer.js@7/dist/plugins/timeline.min.js"></script>
{% endblock %} {% block content %}
<div class="row">
  <div class="col">
    <h2>Filename: {{track.name}}</h2>
    <div id="waveform"></div>
    <button type="button" class="btn">Add comment</button>
    <button id="add_section_button" type="button" class="btn" data-bs-toggle="button">Add section</button>
  </div>
</div>
<div class="row">
  <div class="col">
    <div id="regions-container"></div>
  </div>
</div>

<script>


  // import WaveSurfer from 'wavesurfer.js'
  // import RegionsPlugin from 'wavesurfer.js/dist/plugins/regions.esm.js'

  let file_url = "{{url_for('default.uploads', filename=track.local_name)}}";
  var toggle_regions_create = false;

  const regions = WaveSurfer.Regions.create(); // Initialize regions plugin
  const timeline = WaveSurfer.Timeline.create({
    height: 11,
    timeInterval: 10,
    primaryLabelInterval: 60,
    style: {
      fontSize: '10px',
      color: '#ffffff',
    }
  }); // Initialize timeline plugin
  const hover = WaveSurfer.Hover.create({
    lineColor: "#ffffff",
    lineWidth: 2,
    labelBackground: "#555",
    labelColor: "#fff",
    labelSize: "11px",
  }); // Initialize hover plugin
  const ws = WaveSurfer.create({
    container: "#waveform",
    waveColor: "rgb(83,83,83)",
    progressColor: "rgb(0,182,240)",
    url: file_url,
    // Set a bar width
    barWidth: 10,
    // Optionally, specify the spacing between bars
    barGap: 2,
    // And the bar radius
    barRadius: 4,
    mediaControls: true,
    interact: true,
    dragToSeek: true,
    plugins: [regions, hover, timeline],
  });

  //   ws.once("interaction", () => {
  //     ws.play();
  //   });
  var dragStopCallback = null

  regions.on("region-created", (region) => {
    // console.log("Created region", region);
    renderRegionCard(region)
  });

  regions.on("region-update", (region) => {
    // console.log("Updating region", region);
    updateRegionCard(region)
  });  

  regions.on("region-updated", (region) => {
    // console.log("Updated region", region);
    updateRegionCard(region)
  });

  regions.on("region-in", (region) => {
    console.log("Entering region", region);
  })

  $("#add_section_button").click(function () {
    let btn = $("#add_section_button")
    if (btn.hasClass("active")) {
      $("#add_section_button").addClass("btn-success");
      dragStopCallback = regions.enableDragSelection({
        color: "rgba(0, 200,255, 0.3)",
      });
    } else {
      $("#add_section_button").removeClass("btn-success");
      dragStopCallback()
    }

  });  

  function renderRegionCards(){
    //TODO loop all regions.getRegions()
  }

  function renderRegionCard(region){
    $( "#regions-container" ).append( `
    <div id="${region.id}">
      <div class="card">
        <div class="card-header">
          <div class="form-floating">
            <input type="text" class="form-control" id="${region.id}-content" value="${region.content}">
            <label for="${region.id}-content">Label</label>
          </div>
          
        </div>
        <div class="card-body">
          <!--<h5 class="card-title">Title</h5>-->
          <p class="card-text">Time frame: <span id="${region.id}-start">${secondsToTimestamp(region.start)}</span> - <span id="${region.id}-end">${secondsToTimestamp(region.end)}</span>, Duration: <span id="${region.id}-duration">${secondsToTimestamp(region.end - region.start)}</span></p>
          <div class="form-floating">
            <textarea id="${region.id}-comment" class="form-control" aria-label="With textarea"></textarea>
            <label for="${region.id}-comment">Comment</span>
          </div>
          <a id="${region.id}-save" href="#" class="btn btn-primary">Save</a>
        </div>
      </div>        
    </div>
    ` );
  }

  function updateRegionCard(region){
    $( `#${region.id}-start` ).text( secondsToTimestamp(region.start) )
    $( `#${region.id}-end` ).text( secondsToTimestamp(region.end) )
    $( `#${region.id}-duration` ).text( secondsToTimestamp(region.end - region.start) )
  }

  function secondsToTimestamp(seconds){
    const date = new Date(null);
    date.setSeconds(seconds);
    return date.toISOString().slice(11, 19);
  }
</script>
{% endblock %}